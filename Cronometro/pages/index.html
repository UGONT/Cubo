<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Cronómetro Rubik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module">
        import { randomScrambleForEvent } from "https://cdn.cubing.net/v0/js/cubing/scramble";
        
        // Hacer la función global
        window.obtenerScramble = async function() {
            const scramble = await randomScrambleForEvent("333");
            document.getElementById("scramble").textContent = scramble.toString();
            console.log(scramble.toString());
        }
        
        window.obtenerScramble();
        document.getElementById("nuevoScramble").addEventListener("click", window.obtenerScramble);
	</script>
</head>

<body class="bg-dark text-light text-center p-4">

    <h1 class="mb-4">Cronómetro Rubik</h1>

    <!-- Cronómetro -->
    <div class="display-3 my-4" id="cronometro">00:00.00</div>

    <!-- Scramble -->
    <div class="my-4">
        <h5>Scramble:</h5>
        <p id="scramble">Cargando...</p>
        <button class="btn btn-primary" id="nuevoScramble">Nuevo scramble</button>
    </div>

    <!-- Lista de tiempos -->
    <h4 class="mt-4">Tiempos guardados</h4>
    <ul class="list-group text-dark" id="listaTiempos"></ul>
    

    <script>
	let startTime, interval;
	let running = false;
	let listo = false;
	let timeoutId = null;
	const display = document.getElementById("cronometro");
	const scrambleEl = document.getElementById("scramble");
	
	// -------------------
	// Cronómetro
	// -------------------
	document.addEventListener("keydown", (e) => {
	    if (e.code === "Space" && !running && !listo && !timeoutId) {
	        e.preventDefault();
	        display.style.color = "red";
	        timeoutId = setTimeout(() => {
	            display.style.color = "lime";
	            listo = true;
	        }, 500);
	    }
	});
	
	document.addEventListener("keyup", (e) => {
	    if (e.code === "Space") {
	        e.preventDefault();
	        if (!running && listo) {
	            iniciarCronometro();
	        } else if (!running && !listo) {
	            display.style.color = "white";
	        } else if (running) {
	            detenerCronometro();
	        }
	        clearTimeout(timeoutId);
	        timeoutId = null;
	        listo = false;
	    }
	});
	
	function iniciarCronometro() {
	    startTime = Date.now();
	    interval = setInterval(actualizarDisplay, 10);
	    running = true;
	    display.style.color = "white";
	}
	
	function detenerCronometro() {
        clearInterval(interval);
        let tiempoFinal = display.textContent;
        guardarTiempo(tiempoFinal);
        mostrarTiempos();
        running = false;
        display.style.color = "white";
        
        obtenerScramble(); // Ahora sí funciona
    }
	
	function actualizarDisplay() {
	    let tiempo = Date.now() - startTime;
	    let minutos = Math.floor(tiempo / 60000);
	    let segundos = Math.floor((tiempo % 60000) / 1000);
	    let centesimas = Math.floor((tiempo % 1000) / 10);
	    display.textContent =
	        `${minutos.toString().padStart(2, "0")}:${segundos.toString().padStart(2, "0")}.${centesimas.toString().padStart(2, "0")}`;
	}
	
	// -------------------
	// Guardado en localStorage
	// -------------------
	function guardarTiempo(tiempo) {
	    let tiempos = JSON.parse(localStorage.getItem("tiempos")) || [];
	    tiempos.push(tiempo);
	    localStorage.setItem("tiempos", JSON.stringify(tiempos));
	}
	
	function mostrarTiempos() {
	    listaTiempos.innerHTML = "";
	    let tiempos = JSON.parse(localStorage.getItem("tiempos")) || [];
	    tiempos.forEach((t, index) => {
	        let li = document.createElement("li");
	        li.className = "list-group-item d-flex justify-content-between align-items-center";
	        li.textContent = t;
	
	        let btn = document.createElement("button");
	        btn.className = "btn btn-sm btn-danger";
	        btn.textContent = "X";
	        btn.onclick = () => borrarTiempo(index);
	
	        li.appendChild(btn);
	        listaTiempos.appendChild(li);
	    });
	}
	
	function borrarTiempo(index) {
	    let tiempos = JSON.parse(localStorage.getItem("tiempos")) || [];
	    tiempos.splice(index, 1);
	    localStorage.setItem("tiempos", JSON.stringify(tiempos));
	    mostrarTiempos();
	}
	
	function borrarTodos() {
	    localStorage.removeItem("tiempos");
	    mostrarTiempos();
	}
	

	
	
	
	// Inicialización
	mostrarTiempos();
	
    </script>
</body>
</html>
